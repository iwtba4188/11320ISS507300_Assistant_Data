name: Crawl Dcard Data

on:
  schedule:
    # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡ (UTC æ™‚é–“)
    - cron: '0 * * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/crawl-dcard.yml'

permissions:
  contents: write
  actions: read

jobs:
  crawl-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ› ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Set up Python 3.13.2
      uses: actions/setup-python@v5
      with:
        python-version: '3.13.2'
    
    - name: ğŸ“¦ Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: ğŸ“¥ Install dependencies
      run: |
        echo "::group::Installing dependencies with uv"
        uv sync --frozen
        echo "::endgroup::"
    
    - name: ğŸ“ Create static directory
      run: |
        mkdir -p static
        echo "ğŸ“ Static directory created"
    
    - name: ğŸ” Crawl Dcard URLs
      run: |
        echo "::group::Crawling Dcard URLs"
        echo "ğŸš€ Starting URL crawling process..."
        uv run python src/crawl_dcard_title_urls.py
        echo "âœ… URL crawling completed"
        echo "::endgroup::"
    
    - name: ğŸ“„ Check crawled URLs
      run: |
        if [ -f "static/dcard_urls.csv" ]; then
          echo "ğŸ“Š URLs file found. Number of URLs:"
          wc -l < static/dcard_urls.csv
          echo "ğŸ“‹ First few entries:"
          head -5 static/dcard_urls.csv
        else
          echo "âŒ No URLs file found"
        fi
    
    - name: ğŸ“– Crawl article content
      run: |
        echo "::group::Crawling article content"
        echo "ğŸš€ Starting content crawling process..."
        uv run python src/crawl_dcard_url_content.py
        echo "âœ… Content crawling completed"
        echo "::endgroup::"
    
    - name: ğŸ“Š Check crawled content
      run: |
        if [ -f "static/dcard_contents.json" ]; then
          echo "ğŸ“ Content file found. File size:"
          ls -lh static/dcard_contents.json
          echo "ğŸ“ˆ Number of articles:"
          jq length static/dcard_contents.json
        else
          echo "âŒ No content file found"
        fi
    
    - name: ğŸ“¸ Upload screenshots on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-screenshots-${{ github.run_number }}
        path: "*.png"
        retention-days: 7
    
    - name: ğŸ“¤ Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --exit-code; then
          echo "ğŸ“ No changes to commit"
        else
          echo "ğŸ’¾ Changes detected, committing..."
          git add static/
          
          # ç²å–çµ±è¨ˆè³‡è¨Š
          URLS_COUNT=0
          CONTENT_COUNT=0
          
          if [ -f "static/dcard_urls.csv" ]; then
            URLS_COUNT=$(wc -l < static/dcard_urls.csv)
          fi
          
          if [ -f "static/dcard_contents.json" ]; then
            CONTENT_COUNT=$(jq length static/dcard_contents.json)
          fi
          
          # å‰µå»ºæäº¤è¨Šæ¯
          COMMIT_MSG="ğŸ¤– Auto-crawl: Updated Dcard data

ğŸ“Š Stats:
- URLs: $URLS_COUNT
- Articles: $CONTENT_COUNT
- Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
- Run: #${{ github.run_number }}"
          
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "âœ… Changes committed and pushed successfully"
          echo "ğŸ“ˆ URLs: $URLS_COUNT, Articles: $CONTENT_COUNT"
        fi
    
    - name: ğŸ“‹ Job summary
      if: always()
      run: |
        echo "## ğŸš€ Dcard Crawling Job Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "static/dcard_urls.csv" ]; then
          URLS_COUNT=$(wc -l < static/dcard_urls.csv)
          echo "- ğŸ“„ Total URLs: **$URLS_COUNT**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ğŸ“„ Total URLs: **0** (file not found)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "static/dcard_contents.json" ]; then
          CONTENT_COUNT=$(jq length static/dcard_contents.json)
          echo "- ğŸ“– Total Articles: **$CONTENT_COUNT**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ğŸ“– Total Articles: **0** (file not found)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### â° Execution Info" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ• Started: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”„ Run Number: **#${{ github.run_number }}**" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ Workflow: **${{ github.workflow }}**" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "- âœ… Status: **Success**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Status: **Failed**" >> $GITHUB_STEP_SUMMARY
        fi

env:
  PYTHONPATH: ${{ github.workspace }}
  PYTHONUNBUFFERED: 1
